<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
 
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"> 
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
        <title>carcassonne</title>
        <script type="text/javascript" src="mootools-1.2.4-core.js"></script>
        <script type="text/javascript" src="mootools-1.2.4.4-more.js"></script>
        <script type="text/javascript" src="res.js"></script>
        <script type="text/javascript" src="carcassonne.js"></script>
        <script type="text/javascript">
            var board;
            var tile;

            Element.Events.spacePressed = {
                base: 'keypress',
                condition: function(ev) {
                    return ev.key == 'space' && !ev.alt && !ev.control && !ev.shift;
                }
            };
            Element.Events.enterPressed = {
                base: 'keypress',
                condition: function(ev) {
                    return ev.key == 'enter' && !ev.alt && !ev.control && !ev.shift;
                }
            };

            window.addEvent('domready', function() {
                board = new Board();
                $(board).inject($("cont"));

                $("width").set("text", window.getSize().x);
                $("height").set("text", window.getSize().y);

                window.addEvent('dblclick', function(ev) {
                    var coord = board.abs2GridCoord(ev.page);
                    coord['val'] = board.neighborCnt.get(coord.gX, coord.gY);
                    $("mouse").set("text", "{gX} {gY} {val}".substitute(coord));
                });
                $("addTile").addEvent("click", function() {
                    tile = new Tile(Math.floor(Math.random()*24));
                    $(tile).inject(board);
                    $(tile).addEvent('click', function(ev) {
                        var pos = this.getPosition();
                        $("x").set("text", ev.page.x - pos.x);
                        $("y").set("text", ev.page.y - pos.y);
                        $("target").set("text", ev.target.getProperty('title') + ' ' + ev.target.getProperty('terra'));
                    }).makeDraggable({
                        onStart: function(el) {
                            tile = el.retrieve('tile');
                            tile.getShadow().inject(board);
                            $(tile).inject(board);
                            board.rmTile(tile);
                            tile.setFitStyle();
                        },
                        onDrag: function(el, ev) {
                            var coord = board.abs2OpenGridCoord(ev.page);
                            if (!coord)
                                return;
                            var shadow = tile.getShadow();
                            shadow.setPosition(coord).setStyle('display', 'block').store('gridCoord', coord);
                        },
                        onComplete: function(el) {
                            var t = el.retrieve('tile');
                            var gridCoord = t.getShadow().retrieve('gridCoord');
                            if (gridCoord) {
                                el.inject(board);
                                (new Fx.Morph(el, {duration: 'short', transition: Fx.Transitions.Sine.easeOut})).start({
                                    'left': gridCoord.x,
                                    'top': gridCoord.y
                                });
                                board.addTile(gridCoord, t);
                                t.setNotFitStyle();
                            }
                        },
                    });
                    $each(tile.getAreas(), function(a) {
                        /*
                        var tips = new Tips(a, {
                            'showDelay': 0,
                            'hideDelay': 0,
                            'className': 'meeple',
                            'title': function() {},
                            'offset': {'x': 16, 'y': -16}
                        });*/
                    });
                    this.blur();
                });
                $("rotate").addEvent("click", function() {
                    if (tile)
                        tile.rotate();
                    this.blur();
                });
                $("stop").addEvent("click", function() {
                    if (tile) {
                        $(tile).retrieve('dragger').detach();
                    }
                });
                $("bounds").addEvent("click", function() {
                    if (tile)
                        alert(tile.getBounds());
                });
                window.addEvent("spacePressed", function() {
                    if (tile)
                        tile.rotate();
                    return false;
                });

            });
        </script>
    </head>
    <body>
        <div>
            <div>!!Work only on chrome 4+</div>
            <div>width:<span id="width"></span></div>
            <div>height:<span id="height"></span></div>
            <div>x:<span id="x"></span></div>
            <div>y:<span id="y"></span></div>
            <div>target:<span id="target"></span></div>
            <div>mouse: <span id="mouse"></span></div>
            <input type="button" id="addTile" name="addTile" value="addTile" />
            <input type="button" id="rotate" name="rotate" value="rotate" />
            <input type="button" id="stop" name="stop" value="stop" />
            <input type="button" id="bounds" name="bounds" value="bounds" />
        </div>
        <div id="cont">
        </div>
    </body>
</html>
